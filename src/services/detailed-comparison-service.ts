import { Policy } from "../types";
import { generateText } from "ai";
import { anthropic } from "@ai-sdk/anthropic";
import {
  extractTextFromDocument,
  getUploadedFiles,
} from "@/app/utils/file-utils";
import path from "path";
import fs from "fs";
import {
  analyzePolicyDocument,
  ConsolidatedPolicy,
  consolidatePolicies,
} from "@/new/service/policy-parser";

export async function processAndCompareAllPolicies(): Promise<string> {
  // Step 1: Get all policies processed and ready
  const UPLOADS_DIR = path.resolve(process.cwd(), "uploads");
  const pdfFiles = await getUploadedFiles();
  const policies: Policy[] = [];

  // Process each PDF file
  for (let i = 0; i < pdfFiles.length; i++) {
    const file = pdfFiles[i];
    const filePath = path.join(UPLOADS_DIR, file);

    try {
      // Extract text from PDF
      console.log(`Processing file: ${file}`);
      const text = await extractTextFromDocument(filePath);

      const chapters = analyzePolicyDocument(text);

      // Create policy object
      const policy: Policy = {
        id: `policy-${i + 1}`,
        name: file.replace(/\.[^/.]+$/, ""), // Remove file extension
        chapters,
      };

      policies.push(policy);
      // allPolicyEmbeddings.push(embeddings);
    } catch (error) {
      console.error(`Error processing file ${file}:`, error);
    }
  }

  console.log(`Found ${policies.length} policies, generating answer...`);
  console.log(`Policies: ${JSON.stringify(policies, null, 2)}`);

  fs.writeFileSync("policiesBefore.json", JSON.stringify(policies, null, 2));

  // console.log(consolidatePolicies(policies));

  const finalPolicies = consolidatePolicies(policies);

  fs.writeFileSync("test.json", JSON.stringify(finalPolicies, null, 2));
  // console.log(await findMatchingChapters(policies));

  // return match;
  // return "";
  const text = generateFullPolicyComparison(finalPolicies);
  return text;
}

async function generateFullPolicyComparison(
  policies: ConsolidatedPolicy[]
): Promise<string> {
  // Prepare context for LLM
  fs.writeFileSync("policies.json", JSON.stringify(policies, null, 2));
  const system = `אתה מומחה מוסמך לפוליסות ביטוח בריאות המתמחה בביטוח בריאות בעברית. המשימה שלך: ליצור השוואה מפורטת בין שתי פוליסות העומדת בסטנדרטים מקצועיים.

  ---
  
  ### מתודולוגיית ניתוח
  - עיבוד שתי הפוליסות לפי שם ומזהה.
  - השוואה שיטתית של פרקים ותת-פרקים בכל רמות ההיררכיה.
  - חילוץ סכומי כיסוי מדויקים, תנאים, תקופות המתנה ומגבלות.
  - חיפוש כיסויים מקבילים תחת שמות שונים לפני סימון "לא קיים".
  - חיפוש בכל רמות התת-פרקים וניתוח כל שדות התוכן והכותרות למידע רלוונטי.
  - חישוב הבדלים מוחלטים ואחוזיים בין סכומי הכיסוי.
  - שימוש בציטוטים מדויקים ממסמכי המקור - אין להשתמש בביטויים כלליים.
  - במקרה של מבנים שונים, זיהוי כיסויים מקבילים לפי מינוח וסכומים.
  
  **תנאי התחדשות (חשוב ביותר):**
  - חפש תנאי התחדשות בכל סעיפי הפוליסה, כולל סעיפים מסוג X.X.X, תוך שימוש במונחים כמו "יתחדשו" או "חידוש תקופת הביטוח".
  - חשב את ההשפעה המצטברת ל-5 שנים אם לא מצוין אחרת.
  - שים לב במיוחד לפרק "תרופות מחוץ לסל" - חפש מידע על התחדשות בסעיפים נפרדים.
  
  **ניתוח תנאי התחדשות בתרופות - חובה:**
  - יש להבחין בין "תקופת ביטוח" לבין "התחדשות": אם כתוב "עד X₪ לתקופת ביטוח" זה לא אומר בהכרח שהסכום מתחדש.
  - חשוב מאוד: המונח "מתחדש בעת חידוש תקופת הביטוח" מתייחס בדרך כלל לחידוש הפוליסה כולה (כלומר, בתום תקופת הביטוח), ולא להתחדשות פנימית במהלך תקופת הפוליסה. זה שונה מהותית מניסוח כמו "מתחדש כל X שנים".
  - בחישוב ל-5 שנים: אם הפוליסה מתחדשת רק בתום תקופת הביטוח (בד"כ 3-5 שנים), הסכום עשוי להתחדש פעם אחת בלבד בתקופת החישוב. לעומת זאת, אם יש התחדשות פנימית (למשל "כל שנתיים"), הסכום יתחדש מספר פעמים.
  - חובה לציין מקור מדויק (מספר סעיף וציטוט מילולי) לכל קביעה בנושא התחדשות.
  - בעת ניתוח פרק התרופות, חפש בכל הסעיפים (כולל ההגדרות והתנאים הכלליים) את המילים: "התחדשות", "חידוש", "מצטבר", "לכל תקופת הביטוח", "לכל חיי הפוליסה".
  - אם לא נמצא מידע מפורש על התחדשות, יש לציין "לא מצוין מידע על התחדשות".
  - אסור בשום אופן לכתוב שסכום מתחדש אלא אם צוין במפורש בפוליסה.
  
  **חישוב כספי של השפעת תנאי התחדשות:**
  - חובה לכמת בש"ח את המשמעות של הבדלי מועדי התחדשות לתקופה של 5 שנים.
  - בהערות ההשוואתיות יש לציין: "בחישוב ל-5 שנים: פוליסה X מציעה סה"כ Y₪ (סכום × מספר התחדשויות), פוליסה Z מציעה סה"כ W₪ (סכום × מספר התחדשויות)."
  - יש להדגיש את הפער המספרי המדויק: "פער של X₪ לטובת פוליסה Y".
  
  **דירוג אמינות - חובה:**
  - יש להוסיף דירוג אמינות (1-10) לכל שורה בעמודת "הערות השוואתיות", כאשר:
    - 10 = מידע מדויק המבוסס על ציטוט מפורש מהפוליסה (כולל מספר סעיף)
    - 7-9 = מידע אמין המבוסס על ניסוח דומה בפוליסה
    - 4-6 = מידע המבוסס על פרשנות סבירה אך לא מפורשת
    - 1-3 = מידע שדורש אימות נוסף או שקיימת עמימות משמעותית
  - פורמט: [אמינות: X/10] בסוף כל הערה השוואתית
  - אם דירוג האמינות נמוך מ-7, יש להוסיף הסבר קצר לסיבת הדירוג הנמוך
  
  **בדיקות עקביות - חובה:**
  - לבדוק סתירות פנימיות בניתוח: אם נכתב "לתקופת ביטוח" ו"מתחדש כל שנתיים" יש לוודא שאין סתירה.
  - חשוב לבחון היטב את משמעות המונח "מתחדש בעת חידוש תקופת הביטוח": האם הכוונה לחידוש הפוליסה כולה (אחת ל-3-5 שנים בדרך כלל), או להתחדשות פנימית במהלך תקופת הפוליסה (למשל, אחת לשנתיים).
  - בדוק את עצמך: האם יש הגיון בקביעה שסכום ביטוח "לתקופת ביטוח" מתחדש? אם כן, חייב להיות סעיף מפורש שמציין זאת.
  - לציין בשורה נפרדת בטבלה: "האם הסכום המירבי מתחדש?" עם תשובה ברורה כן/לא והפניה לסעיף. אם כן, חובה לציין באיזו תדירות ולהסביר את המשמעות העובדתית.
  
  **טיפול בעמימות:**
  - אם מידע לא חד-משמעי או סותר, סמן בטבלה עם ⚠️ וציין "מידע לא חד-משמעי, נדרש אימות נוסף מהמסמך".
  
  **חיפוש מונחים חלופיים (במיוחד לפרק "השתלות וטיפולים מיוחדים מחוץ לישראל"):**
  - עבור כיסויים כמו "גמלת החלמה חודשית לאחר השתלה", חפש ביטויים דומים כגון:
    - "גמלה חודשית"
    - "תשלום חודשי"
    - "פיצוי חודשי"
    - "גמלה לאחר השתלה"
    - "גמלה בגין השתלה"
  - נתח את תוכן הסעיפים כדי לזהות כיסויים דומים, גם אם שמות הסעיפים שונים.
  
  ---
  
  ### דרישות תפוקה
  - יצירת טבלאות נפרדות לכל פרק ביטוחי עם פירוט כיסויים מדויק.
  - פירוט מבנה הפוליסות תחת "מבנה הפוליסות":
    - אם יש רבדים, פרט כל רובד ופרקיו.
    - אם אין רבדים, ציין "אין רבדים בפוליסה" ופרט את כל הפרקים.
    - אם יש פרקים עם אפשרויות בחירה (כמו פרק ה'1, ה'2), ציין שזו בחירה אחת מתוך האפשרויות.
  - כימות כל ההבדלים עם חישובים מדויקים (הבדלים מוחלטים ואחוזיים).
  - שימוש בציטוטים מדויקים לתנאי כיסוי וסכומים.
  - סימון "לא קיים" רק לאחר חיפוש מעמיק של מונחים חלופיים ותיאורים דומים.
  - חישוב השפעה כספית של הבדלי כיסוי ותנאי התחדשות.
  - התמקדות בפרטי כיסוי מעשיים וסכומים כספיים, לא בהגדרות.
  - אין ליצור טבלאות נפרדות להגדרות - ציין הבדלים משמעותיים בהגדרות בקצרה בהערות ההשוואתיות רק אם הם משפיעים מהותית על הכיסוי.
  - שמירה על אובייקטיביות תוך זיהוי כיסוי עדיף כשזה ברור.
  - לפרק ניתוחים בישראל, יצירת טבלה אחת משולבת בלבד.
  - אין לכלול מידע על "השתתפות עצמית", "ברות ביטוח" או "תקופת אכשרה".
  
  **הימנעות מסיכום כללי:**
  - אין לכלול סיכום כללי או רשימת יתרונות בסוף המסמך.
  - יש להתמקד אך ורק בניתוח מפורט בטבלאות ההשוואה של כל פרק.
  - כל המסקנות וההערות ההשוואתיות צריכות להופיע רק בעמודת "הערות השוואתיות" בטבלאות עצמן.
  
  ---
  
  **בדיקות קריטיות:**
  - ודא דיוק של נקודות נתונים קריטיות מול המקורות.
  - בדוק שוב תנאי התחדשות ומועדי התחדשות.
  - ודא התאמה נכונה של סעיפים בפרקי השתלות וטיפולים מיוחדים.
  - בדוק שלא בלבלת בין סוגי כיסויים שונים.
  - ודא ש"שיפוי מלא" מצוין רק כשזה מופיע במפורש בפוליסה.
  - בצע בדיקה סופית לפרק תרופות לוודא שתנאי ההתחדשות נכונים.
  
  **בדיקה חוזרת לפרק "השתלות וטיפולים מיוחדים מחוץ לישראל"):**
  - אם כיסוי מסומן כ"לא מוזכר" בפוליסה אחת, חזור ובדוק שוב את כל הסעיפים בפרק כדי לוודא שלא פספסת ניסוח חלופי.
  
  **בדיקה קריטית לזיהוי טעויות:**
  - לפני הגשת התשובה הסופית, בדוק שוב את כל קביעותיך לגבי תנאי התחדשות בשתי הפוליסות.
  - חזור למסמכים המקוריים וחפש סתירות אפשריות.
  - אם אינך מוצא מידע מפורש על התחדשות, אל תניח הנחות - ציין "לא מצוין" במקום לספק מידע שגוי.`;
  // Remove optional sections that aren't currently being used
  // const metaAnalysis = "";
  // const premiumTableSection = "";
  // const employerSection = "";

  // return "test";
  const prompt = `
  <context>
  ${JSON.stringify(policies, null, 2)}
  </context>
  
  **הנחיות להשוואת פוליסות:**
  
  1. **זיהוי הפוליסות**  
     - פוליסה 1: ${policies[0].name} (${policies[0].id})  
     - פוליסה 2: ${policies[1].name} (${policies[1].id})
  
  2. **מבנה הפוליסות**  
     - **פוליסה 1: ${policies[0].name}**  
       - אם יש רבדים, פרט כל רובד ופרקיו.  
       - אם אין רבדים, ציין "אין רבדים בפוליסה" ופרט את כל הפרקים.  
       - אם יש פרקים עם אפשרויות בחירה, ציין שזו בחירה אחת מתוך האפשרויות.  
     - **פוליסה 2: ${policies[1].name}**  
       - אותו הדבר.
  
  3. **השוואת פרקי הפוליסה**  
     - יצירת טבלאות נפרדות לכל פרק ביטוחי מהותי, תוך התמקדות בכיסויים וסכומים (לא בהגדרות).  
     - לפרק ניתוחים בישראל, יצירת טבלה אחת בלבד.  
     - אין לכלול מידע על "השתתפות עצמית", "ברות ביטוח" או "תקופת אכשרה".
  
  **דוגמאות לטבלאות השוואה:**
  
  - **השתלות וטיפולים מיוחדים בחו"ל**  
    | כיסוי | פוליסה 1 | פוליסה 2 | הערות השוואתיות |  
    |---|---|---|---|  
    | סכום ביטוח מרבי להשתלה | עד 5,000,000 ₪ | עד 6,500,000 ₪ | פער של 1,500,000 ₪ (30% יותר) לטובת פוליסה 2 [אמינות: 10/10] |  
    | תשלום לאיתור תורם | עד 350,000 ₪ | עד 350,000 ₪ | זהה בשתי הפוליסות [אמינות: 10/10] |
  
  - **תרופות מחוץ לסל**  
    | כיסוי | פוליסה 1 | פוליסה 2 | הערות השוואתיות |  
    |---|---|---|---|  
    | סכום ביטוח מרבי לתרופות | עד 3,000,000 ₪ לתקופת ביטוח | עד 3,000,000 ₪ לתקופת ביטוח | זהה בשתי הפוליסות [אמינות: 10/10] |
    | האם הסכום המירבי מתחדש? | מתחדש בעת חידוש תקופת הביטוח (סעיף X.X) | כן, מתחדש כל שנתיים (סעיף Y.Y) | הבדל משמעותי: בפוליסה 1, הסכום מתחדש רק בתום תקופת הביטוח (בדרך כלל 3-5 שנים). בפוליסה 2, ההתחדשות היא פנימית, כל שנתיים במהלך הפוליסה. בחישוב ל-5 שנים: פוליסה 1 מציעה בסך הכל 3,000,000 ₪ (בהנחה שאין חידוש בתקופת החישוב), פוליסה 2 מציעה סה"כ 9,000,000 ₪ (3,000,000 ₪ × 2 התחדשויות + הסכום המקורי). פער של 6,000,000 ₪ לטובת פוליסה 2. [אמינות: 10/10] |
  
  - **ניתוחים וטיפולים מחליפי ניתוח בישראל**  
    | כיסוי | פוליסה 1 | פוליסה 2 | הערות השוואתיות |  
    |---|---|---|---|  
    | סוגי ניתוחים מכוסים | כל סוגי הניתוחים לפי התקנות | כל סוגי הניתוחים לפי התקנות | זהה בשתי הפוליסות, כיוון שהפרק רגולטורי [אמינות: 10/10] |
  
  **דירוג אמינות:**
  - יש להוסיף דירוג אמינות (1-10) לכל שורה בעמודת "הערות השוואתיות", כאשר:
    - 10 = מידע מדויק המבוסס על ציטוט מפורש מהפוליסה (כולל מספר סעיף)
    - 7-9 = מידע אמין המבוסס על ניסוח דומה בפוליסה
    - 4-6 = מידע המבוסס על פרשנות סבירה אך לא מפורשת
    - 1-3 = מידע שדורש אימות נוסף או שקיימת עמימות משמעותית
  - פורמט: [אמינות: X/10] בסוף כל הערה השוואתית
  - אם דירוג האמינות נמוך מ-7, יש להוסיף הסבר קצר לסיבת הדירוג הנמוך
  
  **חישוב כספי של השפעת תנאי התחדשות:**
  - חובה לכמת בש"ח את המשמעות של הבדלי מועדי התחדשות לתקופה של 5 שנים.
  - בהערות ההשוואתיות יש לציין: "בחישוב ל-5 שנים: פוליסה X מציעה סה"כ Y₪ (סכום × מספר התחדשויות), פוליסה Z מציעה סה"כ W₪ (סכום × מספר התחדשויות)."
  - יש להדגיש את הפער המספרי המדויק: "פער של X₪ לטובת פוליסה Y".
  
  **הנחיות נוספות:**
  - אם מבנה הפוליסות שונה מאוד, צור טבלת מיפוי ראשונית שמתאימה בין פרקים מקבילים.
  - במקרה של ספק לגבי מונח או סכום, בקש הבהרה מהמשתמש (אם אפשרי) או סמן בטבלה עם ⚠️ וציין "נדרש אימות נוסף".
  
**בדיקות עקביות - חובה:**
- לבדוק סתירות פנימיות בניתוח: אם נכתב "לתקופת ביטוח" ו"מתחדש כל שנתיים" יש לוודא שאין סתירה.
- חשוב לבחון היטב את משמעות המונח "מתחדש בעת חידוש תקופת הביטוח": האם הכוונה לחידוש הפוליסה כולה (אחת ל-3-5 שנים בדרך כלל), או להתחדשות פנימית במהלך תקופת הפוליסה (למשל, אחת לשנתיים).
- בדוק את עצמך: האם יש הגיון בקביעה שסכום ביטוח "לתקופת ביטוח" מתחדש? אם כן, חייב להיות סעיף מפורש שמציין זאת.
- לציין בשורה נפרדת בטבלה: "האם הסכום המירבי מתחדש?" עם תשובה ברורה כן/לא והפניה לסעיף. אם כן, חובה לציין באיזו תדירות ולהסביר את המשמעות העובדתית.

**הימנעות מסיכום כללי:**
- אין לכלול סיכום כללי או רשימת יתרונות בסוף המסמך.
- יש להתמקד אך ורק בניתוח מפורט בטבלאות ההשוואה של כל פרק.
- כל המסקנות וההערות ההשוואתיות צריכות להופיע רק בעמודת "הערות השוואתיות" בטבלאות עצמן.

**בדיקה קריטית לזיהוי טעויות:**
- לפני הגשת התשובה הסופית, בדוק שוב את כל קביעותיך לגבי תנאי התחדשות בשתי הפוליסות.
- חזור למסמכים המקוריים וחפש סתירות אפשריות.
- אם אינך מוצא מידע מפורש על התחדשות, אל תניח הנחות - ציין "לא מצוין" במקום לספק מידע שגוי.

**בדיקה עצמית:**
- ודא שכל נתון בטבלה זהה למה שמופיע במקור.
- בדוק שוב תנאי התחדשות וחישובים מצטברים.
- ודא שלא בלבלת בין סוגי כיסויים שונים.
- שים לב במיוחד להבדל בין "חידוש תקופת ביטוח" (חידוש הפוליסה) לבין "התחדשות פנימית" (בתוך תקופת הפוליסה).`;

  try {
    const response = await generateText({
      model: anthropic("claude-opus-4-20250514"),
      prompt,
      system,
      temperature: 0.1,
      maxTokens: 10000,
    });

    return response.text || "Failed to generate comparison";
  } catch (error) {
    console.error("Error generating detailed comparison:", error);
    throw new Error("Failed to generate detailed policy comparison");
  }
}
